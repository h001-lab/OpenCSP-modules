---
- name: Flux CLI 설치
  shell: curl -s https://fluxcd.io/install.sh | sudo bash
  args:
    creates: /usr/local/bin/flux

- name: Flux 설치 여부 확인 (Check flux-system namespace)
  shell: kubectl get namespace flux-system
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: flux_namespace_check
  # ignore_errors: true
  failed_when: flux_namespace_check.rc not in [0, 1] # 최초 실행 시는 namespace가 없지만 에러 아님 (무시), 이후는 있을 경우 
  changed_when: false

- name: Flux Bootstrap 실행 (GitHub)
  shell: |
    flux bootstrap github \
      --owner={{ github_user }} \
      --repository={{ github_repo }} \
      --branch=main \
      --path={{ flux_path }} \
      --token-auth
  environment:
    GITHUB_TOKEN: "{{ github_token }}"
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  when: flux_namespace_check.rc != 0
  register: flux_result
  changed_when: "'configured' in flux_result.stderr"
  failed_when: 
    - flux_result.rc != 0