---
- name: Helm 설치 여부 확인
  shell: command -v helm >/dev/null 2>&1
  register: helm_check
  ignore_errors: yes

- name: Helm 설치 (없을 경우)
  shell: curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  when: helm_check.failed

- name: Cilium Helm Repo 추가
  kubernetes.core.helm_repository:
    name: cilium
    repo_url: "https://helm.cilium.io/"

- name: Cilium 설치 (kube-system)
  kubernetes.core.helm:
    name: cilium
    chart_ref: cilium/cilium
    release_namespace: kube-system
    chart_version: "1.18.6"
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    values:
      k8sServiceHost: "{{ ansible_host }}"
      k8sServicePort: 6443
      kubeProxyReplacement: "true"
      ipam:
        mode: "cluster-pool"
        operator:
          clusterPoolIPv4PodCIDRList: ["10.42.0.0/16"]

# - name: Cilium 설치 (kube-system)
#   kubernetes.core.helm:
#     name: cilium
#     chart_ref: cilium/cilium
#     release_namespace: kube-system
#     create_namespace: true
#     chart_version: "1.14.5"
#     kubeconfig: /etc/rancher/k3s/k3s.yaml
#     values:
#       k8sServiceHost: "{{ ansible_host }}"
#       k8sServicePort: 6443
#       kubeProxyReplacement: "true"
#       securityContext:
#         capabilities:
#           ciliumAgent:
#             - CHOWN
#             - KILL
#             - NET_ADMIN
#             - NET_RAW
#             - IPC_LOCK
#             - SYS_ADMIN
#             - SYS_RESOURCE
#             - DAC_OVERRIDE
#             - FOWNER
#             - SETGID
#             - SETUID
#           cleanCiliumState:
#             - NET_ADMIN
#             - SYS_ADMIN
#             - SYS_RESOURCE